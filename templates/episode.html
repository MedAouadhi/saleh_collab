{% extends 'base.html' %}

{% block title %}{{ episode.title }} - ØµØ§Ù„Ø­ - Ø§Ù„ÙƒØ±Ø§Ø³Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ ğŸ“•{% endblock %}

{% block content %}
{# Changed main grid to 4 columns on large screens #}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

    {# Main content now takes 3 out of 4 columns on large screens #}
    <div class="lg:col-span-3 space-y-6 text-right"> {# Added text-right #}
        {# Header with Title and Export Button #}
        <div class="flex justify-between items-center mb-2">
             <h1 class="text-3xl font-bold text-gray-800">{{ episode.title }}</h1>
             <a href="{{ url_for('export_episode_pdf', episode_id=episode.id) }}"
                target="_blank"
                class="bg-emerald-500 hover:bg-emerald-600 text-white py-2 px-4 rounded text-sm btn-hover-effect no-underline">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /> </svg>
                 ØªØµØ¯ÙŠØ± PDF
             </a>
        </div>

        {# ... (Plan section remains the same) ... #}
         <div class="bg-white p-6 rounded-lg shadow-md"> <div class="flex justify-between items-center mb-3 border-b pb-2"> <h2 class="text-xl font-semibold text-gray-700">Ø®Ø·Ø© Ø§Ù„Ø­Ù„Ù‚Ø©</h2> {% if is_assigned %} <div class="flex space-x-reverse space-x-2"> <button id="view-plan-btn" class="plan-toggle-btn active px-3 py-1 text-sm rounded bg-indigo-100 text-indigo-700 font-medium"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg> Ø¹Ø±Ø¶ </button> <button id="edit-plan-btn" class="plan-toggle-btn px-3 py-1 text-sm rounded text-gray-600 hover:bg-gray-100"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> ØªØ¹Ø¯ÙŠÙ„ </button> </div> {% endif %} </div> <div id="plan-display" class="prose max-w-none text-right"></div> {% if is_assigned %} <div id="plan-editor-wrapper" class="hidden"> <textarea id="plan-area" name="plan" rows="10" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 resize-y text-right" placeholder="Ø£Ø¯Ø®Ù„ Ø®Ø·Ø© Ø§Ù„Ø­Ù„Ù‚Ø© Ù‡Ù†Ø§ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Markdown)...">{{ episode.plan or '' }}</textarea> <button id="save-plan-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded text-sm btn-hover-effect"> Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø© </button> <span id="plan-status" class="mr-3 text-sm text-gray-500"></span> </div> {% else %} <p class="mt-2 text-sm text-gray-500 italic">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø¹ÙŠÙ†Ù‹Ø§ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©.</p> {% endif %} </div>

        {# ... (Scenario section remains the same) ... #}
        <div class="bg-white p-6 rounded-lg shadow-md"> <div class="flex justify-between items-center mb-3 border-b pb-2"> <h2 class="text-xl font-semibold text-gray-700">Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ</h2> {% if is_assigned %} <div class="flex space-x-reverse space-x-2"> <button id="view-scenario-btn" class="scenario-toggle-btn active px-3 py-1 text-sm rounded bg-indigo-100 text-indigo-700 font-medium"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg> Ø¹Ø±Ø¶ </button> <button id="edit-scenario-btn" class="scenario-toggle-btn px-3 py-1 text-sm rounded text-gray-600 hover:bg-gray-100"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> ØªØ¹Ø¯ÙŠÙ„ </button> </div> {% endif %} </div> <div id="scenario-display" class="prose max-w-none text-right"> </div> {% if is_assigned %} <div id="scenario-editor-wrapper" class="hidden"> <textarea id="scenario-area" name="scenario" rows="18" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 resize-y text-right" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù‡Ù†Ø§ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Markdown)...">{{ episode.scenario or '' }}</textarea> <button id="save-scenario-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded text-sm btn-hover-effect"> Ø­ÙØ¸ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ </button> <span id="scenario-status" class="mr-3 text-sm text-gray-500"></span> </div> <p id="comment-instruction" class="text-xs text-gray-500 mt-2">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ ÙÙ‚Ø±Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚.</p> {% else %} <p class="mt-2 text-sm text-gray-500 italic">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø¹ÙŠÙ†Ù‹Ø§ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚Ø§Øª.</p> {% endif %} </div>
    </div>

    {# Sidebar now takes 1 out of 4 columns on large screens #}
    <div class="lg:col-span-1 space-y-6 text-right"> {# Added text-right #}

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª</h2>
            {# ... (Display Assignees, Assign User Form, Unassign Self Button remain same) ... #}
             <div class="mb-4"> <p class="text-sm font-medium text-gray-600">Ø§Ù„Ù…Ø¹ÙŠÙ†ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹:</p> {% if episode.assignees %} <div class="flex flex-wrap gap-1 mt-1 justify-end"> {% for user in episode.assignees %} <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded {% if user.id == current_user.id %} ring-1 ring-indigo-400 {% endif %}"> {{ user.username }} {% if user.id == current_user.id %}(Ø£Ù†Øª){% endif %} </span> {% endfor %} </div> {% else %} <p class="text-sm text-gray-500 italic mt-1">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø¹ÙŠÙ†ÙˆÙ† Ø¨Ø¹Ø¯.</p> {% endif %} </div>
             <form action="{{ url_for('assign_user_to_episode') }}" method="POST" class="space-y-2 mb-4 border-b pb-4"> <input type="hidden" name="episode_id" value="{{ episode.id }}"> <div> <label for="user_to_assign_id" class="block text-sm font-medium text-gray-700">ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªØ®Ø¯Ù…:</label> <select name="user_to_assign_id" id="user_to_assign_id" required class="mt-1 block w-full shadow-sm appearance-none border border-gray-300 rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-transparent transition duration-200"> <option value="" disabled selected>Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…...</option> {% for user in all_users %} {% set is_already_assigned = user in episode.assignees %} <option value="{{ user.id }}" {% if is_already_assigned %}disabled class="text-gray-400"{% endif %}> {{ user.username }} {% if is_already_assigned %}(Ù…Ø¹ÙŠÙ† Ø¨Ø§Ù„ÙØ¹Ù„){% endif %} </option> {% endfor %} </select> </div> <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded focus:outline-none focus:shadow-outline btn-hover-effect"> ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… </button> </form>
             {% if is_assigned %} <form action="{{ url_for('unassign_self_from_episode', episode_id=episode.id) }}" method="POST" class="unassign-self-form"> <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-yellow-900 text-sm font-semibold py-2 px-4 rounded focus:outline-none focus:shadow-outline btn-hover-effect"> Ø¥Ù„ØºØ§Ø¡ ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ÙŠ </button> </form> {% endif %}

            {# --- NEW: Change Maslak Form --- #}
            {% if is_assigned or user_is_admin %} {# Show if assigned or admin #}
            <div class="mt-4 pt-4 border-t">
                <h3 class="text-md font-semibold text-gray-700 mb-2">ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ù„Ùƒ</h3>
                <form action="{{ url_for('change_episode_maslak', episode_id=episode.id) }}" method="POST">
                     <label for="new_maslak_id" class="sr-only">Ø§Ù„Ù…Ø³Ù„Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label> {# Screen reader label #}
                     <select name="new_maslak_id" id="new_maslak_id" required
                             class="block w-full shadow-sm border border-gray-300 rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-transparent transition duration-200 mb-2">
                         <option value="" disabled>-- Ø§Ø®ØªØ± Ù…Ø³Ù„Ùƒ Ø¬Ø¯ÙŠØ¯ --</option>
                         {% for maslak in all_maslaks %}
                             <option value="{{ maslak.id }}" {% if episode.maslak_id == maslak.id %}selected{% endif %}>
                                 {{ maslak.name }}
                             </option>
                         {% else %}
                             <option value="" disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ù„Ùƒ Ø£Ø®Ø±Ù‰ Ù…ØªØ§Ø­Ø©.</option>
                         {% endfor %}
                     </select>
                     <button type="submit"
                             class="w-full bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold py-2 px-4 rounded focus:outline-none focus:shadow-outline btn-hover-effect">
                         ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ù„Ùƒ
                     </button>
                </form>
            </div>
            {% endif %}
            {# --- End Change Maslak Form --- #}

        </div>


        {# ... (Comments section remains the same) ... #}
         <div class="bg-white p-6 rounded-lg shadow-md"> <h2 class="text-xl font-semibold text-gray-700 mb-3">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h2> <div id="comment-display-area" class="space-y-4 comment-section"> <p id="no-comments-msg" class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯. {% if is_assigned %}Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ ÙÙ‚Ø±Ø© ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚.{% else %}Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³Ùƒ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚Ø§Øª.{% endif %}</p> </div> {% if is_assigned %} <div id="comment-form-container" class="mt-6 border-t pt-4 hidden"> <h3 class="text-md font-semibold text-gray-700 mb-2">Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ Ù„Ù„ÙÙ‚Ø±Ø© Ø±Ù‚Ù… <span id="comment-block-index" class="font-bold"></span></h3> <textarea id="comment-text" rows="3" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-400 transition duration-200 text-right" placeholder="Ø£Ø¯Ø®Ù„ ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea> <div class="mt-2 flex justify-end space-x-reverse space-x-2"> <button id="cancel-comment-btn" class="bg-gray-400 hover:bg-gray-500 text-white py-1 px-3 rounded text-sm btn-hover-effect">Ø¥Ù„ØºØ§Ø¡</button> <button id="submit-comment-btn" class="bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded text-sm btn-hover-effect">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button> </div> <div id="comment-status" class="text-sm text-red-500 mt-1"></div> </div> {% endif %} </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const EPISODE_ID = {{ episode.id | default('null') | tojson }};
    const INITIAL_PLAN = {{ episode.plan | default('') | tojson }};
    const INITIAL_SCENARIO = {{ episode.scenario | default('') | tojson }};
    const INITIAL_COMMENTS_BY_BLOCK = {{ comments_by_block | default({}) | tojson }};
    const IS_ASSIGNED = {{ is_assigned | default(false) | tojson }};
    const CURRENT_USER_ID = {{ current_user.id | default('null') | tojson }};
    const EPISODE_TITLE = {{ episode.title | tojson }};
    const IS_ADMIN = {{ user_is_admin | default(false) | tojson }};
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const unassignForms = document.querySelectorAll('.unassign-self-form');
        unassignForms.forEach(form => {
            form.addEventListener('submit', function(event) {
                const confirmed = confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³Ùƒ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø©ØŸ');
                if (!confirmed) { event.preventDefault(); }
            });
        });
    });
</script>
{% endblock %}
